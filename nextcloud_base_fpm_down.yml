- name: playbook generated by doco2podans to remove Nextcloud
  hosts: all
  gather_facts: false
  become: true  # we don't expect most docker compose to work without root

  tasks:
    - name: block again firewall
      ansible.posix.firewalld:
        immediate: true
        permanent: true
        port: 8080/tcp
        state: disabled
    - name: destroy container web
      containers.podman.podman_container:
        name: web
        state: absent
        image: docker.io/library/nginx
        restart_policy: always
        ports:
        - 8080:80
        volumes:
        - /srv/nextcloud_nginx.conf:/etc/nginx/nginx.conf:ro,Z
        volumes_from:
        - app
        network: nw-app-db-web
    - name: destroy container app
      containers.podman.podman_container:
        name: app
        state: absent
        image: docker.io/library/nextcloud:fpm
        restart_policy: always
        volumes:
        - nextcloud:/var/www/html:z
        env:
          MYSQL_PASSWORD: changeme
          MYSQL_DATABASE: nextcloud
          MYSQL_USER: nextcloud
          MYSQL_HOST: db
        network: nw-app-db-web
    - name: destroy container db
      containers.podman.podman_container:
        name: db
        state: absent
        image: docker.io/library/mariadb:10.5
        restart_policy: always
        command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
        volumes:
        - db:/var/lib/mysql:Z
        env:
          MYSQL_ROOT_PASSWORD: changeme
          MYSQL_PASSWORD: changeme
          MYSQL_DATABASE: nextcloud
          MYSQL_USER: nextcloud
        network: nw-app-db-web
    - name: destroy network nw-app-db-web
      containers.podman.podman_network:
        name: nw-app-db-web
        state: absent
    - name: destroy volume db
      containers.podman.podman_volume:
        name: db
        state: absent
    - name: destroy volume nextcloud
      containers.podman.podman_volume:
        name: nextcloud
        state: absent
    - name: make sure podman is absent
      package:
        name:
          - podman
          - podman-plugins
        state: absent
    - name: make sure nginx.conf is absent
      file:
        dest: /srv/nextcloud_nginx.conf
        state: absent
